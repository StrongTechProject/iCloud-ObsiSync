## 📚 Obsidian Vault 自动 Git 同步流程文档

### 1. 流程概述

本流程旨在将存储在 **iCloud Drive** 中的 Obsidian Vault 笔记库自动同步（镜像备份）到本地指定目录，并利用 **Git** 工具将所有变动提交（Commit）并推送到 **GitHub** 远程仓库，实现 Obsidian 笔记的自动化版本管理和异地备份。

该流程通过 **Cron Job** 或其他自动化工具定时执行 Shell 脚本 (`sync_and_push.sh`) 实现无人值守运行。

------

### 2. 文件结构与路径

所有相关文件和日志都集中存放在一个管理文件夹内。

| **文件/目录**     | **路径示例**                                              | **作用描述**                                                 |
| ----------------- | --------------------------------------------------------- | ------------------------------------------------------------ |
| **脚本文件**      | `/path/to/your/script/sync_and_push.sh` | 核心执行脚本，包含 Rsync 和 Git 逻辑。                       |
| **日志目录**      | `/path/to/your/logs/directory/`            | 存放每日的执行日志文件（例如 `backup-2025-12-11.log`）。       |
| **iCloud 源**     | `/Users/your_username/Library/Mobile Documents/.../your_vault`         | ** Obsidian Vault 的原始 iCloud 路径（Source）。**           |
| **本地 Git 仓库** | `/path/to/your/local/git/repo`                           | **脚本的目标路径（Destination），必须是一个已初始化的 Git 仓库。** |

------

### 3. 脚本 (`sync_and_push.sh`) 工作原理

脚本包含四个主要阶段：日志处理、同步、目录切换和 Git 操作。

#### 3.1. 阶段零：日志初始化与清理 (新功能)

在任何同步操作之前，脚本会首先处理日志：
- **确保目录存在**: 检查并创建 `logs` 目录。
- **清理旧日志**: 自动查找并删除超过 `LOG_RETENTION_DAYS`（默认为7天）的旧日志文件。
- **定义当日日志**: 设置一个以当天日期命名的动态日志文件路径 (e.g., `logs/backup-2025-12-11.log`)，供后续所有步骤使用。

#### 3.2. 阶段一：iCloud 镜像同步 (Rsync)

- **命令**：`rsync -av --delete --exclude '.git' ...`
- **功能**：将 iCloud 源目录的文件**完全镜像**到本地 Git 仓库目录。
  - `--delete`: **关键**。确保如果源（iCloud）删除了文件，目标（本地 Git 仓库）也会同步删除。
  - `--exclude '.git'`: 保护本地 Git 仓库的元数据不被 Rsync 覆盖或删除。
- **退出机制**：如果 Rsync 失败，脚本会立即终止。

#### 3.3. 阶段二：环境切换

- **命令**：`cd "$DEST_DIR" || exit 1`
- **功能**：将当前工作目录切换到本地 Git 仓库。这是确保后续所有 `git` 命令正确执行的关键。

#### 3.4. 阶段三：Git 提交与推送

1. **检查变动**：使用 `git status -s` 检查工作目录是否有未提交的更改。
2. **提交 (Commit)**：如果检测到变动，执行 `git add .` 和 `git commit`。提交信息是自动生成的日期和时间。
3. **推送 (Push)**：使用 **SSH Key** 安全地推送到远程 GitHub 仓库的 `main` 分支。

------

### 4. 日志系统（重要更新）

旧的单一 `backup.log` 文件已被全新的日志系统取代：

- **每日日志**: 每次运行，日志都会被写入到 `logs` 目录下当天对应的文件中 (e.g., `backup-2025-12-11.log`)。
- **自动轮换与清理**: 脚本会自动删除超过指定天数的旧日志，无需手动管理，防止日志目录无限膨胀。
- **可配置保留期**: 你可以通过修改 `sync_and_push.sh` 脚本顶部的 `LOG_RETENTION_DAYS=7` 变量，轻松调整日志的保留时长（单位：天）。

------

### 5. 维护与故障排除 (Troubleshooting)

| **场景**                                             | **故障排查/解决方案**                                        | **维护点**                                                   |
| ---------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **同步失败，日志提示 `Rsync 同步失败`**              | 1. 检查 `$SOURCE_DIR` 路径是否正确。 2. 检查脚本执行用户对源目录是否有读取权限。 | **路径检查**：定期确认 iCloud 路径未变动。                   |
| **Rsync 成功，但日志提示 `Git Push 失败`**           | 1. **SSH Key 权限**：确认私钥 (`/path/to/your/private/ssh_key`) 存在且权限正确 (`chmod 600`)。 2. **Key 是否添加到 GitHub**：确认公钥已添加到 GitHub 账户。 3. **网络**：检查脚本执行时是否有稳定的网络连接。 | **认证检查**：手动在终端运行 `ssh -T git@github.com` 测试连接。 |
| **日志提示 `无变动` (但文件实际已修改)** | 1. **检查 `cd` 命令**：确认脚本的 `cd "$DEST_DIR"` 是否正确。 2. **`.gitignore` 忽略**：检查 `.gitignore` 文件是否错误地忽略了新文件。 | **查看日志**：打开 `logs` 目录中最新的日志文件，查看详细输出。 |
| **日志中文件名显示乱码**                             | 脚本中已添加 `export LC_ALL=en_US.UTF-8` 和 `git config core.quotepath false` 来解决此问题。 | **环境配置**：确保脚本执行环境支持 UTF-8。                   |

------

### 6. 迭代与改进方向

| **改进方向**        | **目的**                                                     | **实现建议**                                                 |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **自动拉取 (Pull)** | 在 Rsync 同步前执行 `git pull`，确保本地 Git 仓库始终是远程最新版本，防止 Rsync 覆盖 Git 提交记录。 | 在 `cd "$DEST_DIR"` 后、`git status` 前添加 `git pull origin main`。 |
| **冲突处理**        | 增加冲突检测机制，当 `git pull` 或 `git push` 失败时，输出更详细的诊断信息。 | 使用 `git merge-tree` 或检查 `git pull` 的退出状态，并在发现冲突时发送邮件通知。 |