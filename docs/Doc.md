#  Obsidian-Timemachine Documentation

## 1. Overview

This workflow is designed to automatically sync (mirror backup) an Obsidian Vault stored in **iCloud Drive or any local directory** to a specified local directory, and use **Git** to commit and push all changes to a remote **GitHub** repository. This achieves automated version control and off-site backup for your Obsidian notes.

###  Key Features
- **One-Click Install**: Provides an `install.sh` script to clone the repo and start the setup wizard.
- **Auto-Config Wizard**: Provides a `setup.sh` script to interactively configure the environment.
- **Secure Configuration**: The `config.sh` file containing sensitive paths is separated and ignored by Git by default.
- **Smart Logging**: Generates daily logs, automatically cleans up old logs, and supports absolute paths (Cron-friendly).
- **Automated Sync**: Integrates Rsync mirroring with Git commit/push workflow.

---

## 2. Quick Start

### 2.1 Installation & Configuration

**Recommended: One-Click Installation**
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/StrongTechProject/Obsidian-Timemachine/main/src/install.sh)"
```
This script will automatically clone the repository, set up the environment, and attempt to create a global shortcut command `obsis`.

**Management & Configuration:**

After installation, you can launch the management menu directly by typing:
```bash
obsis
```
*(If the shortcut wasn't created, use `./src/menu.sh`)*

Menu Functions:
*   **1. Quick Start**: Run the initial configuration wizard.
    *   *The script will guide you to enter the Obsidian vault source path, local Git repo path, and SSH Key. If the Obsidian vault path and local Git repo path are identical, the script will perform Git operations directly on the vault without an intermediate Rsync sync.*
    *   *If your local repo lacks a remote address (Remote Origin), the script will guide you to add it.*
*   **2. Check Sync Status**: Immediately run a sync and analyze the logs to report success or failure.
*   **3. Modify Config**: 
    *   Change Git repository path or log directory.
    *   **Auto-Sync Frequency**: View, add, or disable auto-sync tasks (Crontab).
*   **4. View Logs**: View the latest synchronization log in real-time.
*   **5. Uninstall**: Clean up project files.

### 2.2 Manual Test Run
After configuration, you can try running the main script manually:
```bash
obsis
# Select option 2 (Check Sync Status)
# Or run directly in terminal:
./src/sync_and_push.sh
```
Check the terminal output or the latest log file in the logs directory to confirm success.

---

## 3. File Structure

| **File/Directory** | **Example Path** | **Description** |
| :--- | :--- | :--- |
| **Menu Script** | `src/menu.sh` | **Recommended Entry**. Can be invoked via `obsis` command. |
| **Install Script** | `src/install.sh` | **One-Click Install**. Handles cloning and configuring `obsis` shortcut. |
| **Setup Script** | `src/setup.sh` | **Config Wizard**. Generates config file, checks environment, and sets Git Remote. |
| **Core Script** | `src/sync_and_push.sh` | **Cron Target**. Executes the core logic for sync, commit, and push. |
| **Config File** | `src/config.sh` | Generated by `setup.sh`. Contains sensitive paths/keys. **Ignored by .gitignore**. |
| **Logs Dir** | `src/logs/` (Default) | Stores daily logs (e.g., `backup-2025-12-11.log`). Path is customizable. |
| **Documentation** | `docs/Doc.md` | This documentation file. |

---

## 4. Automated Deployment (Cron Job)

**Recommended Method:**
Use the **"3. Modify Config -> 3. Auto-Sync Frequency"** option in the `obsis` menu to graphically set up scheduled tasks (supports presets like every 15 mins, hourly, daily, etc.).

**Manual Method (Advanced Users):**
If you prefer manual management, you can edit `crontab -e`:

1. Edit Crontab:
   ```bash
   crontab -e
   ```

2. Add a scheduled task (Example: Run every 20 minutes):
   ```cron
   */20 * * * * /path/to/Obsidian-Timemachine/src/sync_and_push.sh
   ```
   *> Note: Ensure you use the **absolute path** to the script.*

---

## 5. Technical Details

### 5.1 Script Workflow (`sync_and_push.sh`)

1. **Load Config**: Automatically finds and loads `config.sh` in the same directory.
2. **Environment Prep**:
   - Sets global `GIT_SSH_COMMAND` to ensure Git uses the specified SSH Key.
   - Ensures the log directory exists (handles absolute paths).
3. **Log Rotation**: Checks the log directory and automatically deletes old logs older than `LOG_RETENTION_DAYS` (default 7 days).
4. **Git Pull**: Attempts to pull remote updates to prevent local commit conflicts.
5. **Rsync Sync**: Conditionally mirrors the source directory to the local Git repo (with `--delete` flag to keep exact consistency). **This step is skipped if the source and destination directories are identical, allowing for direct Git management of the Obsidian vault.**
6. **Git Push**: Checks for changes; if any, automatically commits and pushes to the remote `main` branch.

### 5.2 Security

- **SSH Key**: The script does not rely on SSH Agent but explicitly specifies the private key path via `GIT_SSH_COMMAND`, ensuring stability in Cron environments.
- **Gitignore**: `config.sh` and `logs/` directory are ignored by default, preventing personal paths and logs from being committed to the public repo.

---

## 6. Troubleshooting

| **Issue** | **Possible Cause** | **Solution** |
| :--- | :--- | :--- |
| **"Permission denied" during setup** | Script lacks execution rights | Run `chmod +x src/setup.sh` |
| **Cron job not running or no logs** | Path issues | 1. Ensure absolute paths in Crontab.<br>2. Check if `LOG_DIR` in `config.sh` is absolute (`setup.sh` handles this). |
| **Git Push Failed (Permission denied)** | SSH Key path/perm error | 1. Check `SSH_KEY_PATH` in `config.sh`.<br>2. Ensure private key permission is 600 (`chmod 600 ~/.ssh/id_rsa`). |
| **Rsync "Operation not permitted"** | No disk access for Terminal/Cron | Add `Terminal`, `iTerm`, or `cron` to "System Settings -> Privacy & Security -> Full Disk Access". |